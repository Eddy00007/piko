name: Sync dev to Test

on:
  push:
    branches:
      - dev

jobs:
  sync_branches:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout Code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up Git user
        run: |
          git config user.name "GitHub Actions"
          git config user.email "actions@github.com"

      - name: Try to Merge dev into Test
        id: merge
        run: |
          git checkout Test
          git merge dev --no-ff --commit -m "Auto-merge dev into Test"
        continue-on-error: true  # Contin√∫a incluso si hay un error

      # Push de los cambios si el merge fue exitoso
      - name: Push changes to Test branch
        if: success()  # Solo se ejecuta si el merge tuvo √©xito
        run: |
          git push origin Test
        env:
          GITHUB_TOKEN: ${{ secrets.WORKFLOW_TOKEN }}

      # Enviar notificaci√≥n si hay conflictos en el merge
      - name: Notify on Merge Conflict
        if: failure()  # Solo se ejecuta si el paso de merge falla
        run: |
          curl -s -X POST https://api.telegram.org/bot${{ secrets.TELEGRAM_TOKEN }}/sendMessage \
          -d chat_id=${{ secrets.CHAT_ID }} \
          -d text="üö® Conflicto detectado al intentar hacer merge de 'dev' en 'Test'. Requiere intervenci√≥n manual."


      # Subir cambios si el merge fue exitoso
      - name: Push changes
        run: |
          git push origin Test
        env:
          GITHUB_TOKEN: ${{ secrets.WORKFLOW_TOKEN }}  # Usa el token secreto de GitHub para autenticaci√≥n
